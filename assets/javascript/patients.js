var config = {
    apiKey: "AIzaSyCxjZqhAWrp3vf_wanuS7_iYem_1eLattA",
    authDomain: "inpatient-8a288.firebaseapp.com",
    databaseURL: "https://inpatient-8a288.firebaseio.com",
    storageBucket: "inpatient-8a288.appspot.com",
    messagingSenderId: "607664151265"
};
firebase.initializeApp(config);

inPatientDatabase = firebase.database();

$(document).ready(function(){

    //initialize modal by ID
    $("#drug_info_modal").modal();

    $("#single_patient").hide();

    $("#add_patient_btn").on("click", function(event){
        event.preventDefault();
        window.location.href = "patient_form.html";
    });

    $("#log_out_btn").on("click", function(event){
       event.preventDefault();
       window.location.href = "login.html";
    });

    inPatientDatabase.ref().on("child_added", function(childSnapshot){
        //current child key generated by firebase
        var patient_Database_Key = childSnapshot.key;

        //screenshots of current information by child
        var first_name = childSnapshot.val().first_name;
        var last_name = childSnapshot.val().last_name;
        var gender = childSnapshot.val().gender;
        var DOB = childSnapshot.val().DOB;
        var phone = childSnapshot.val().phone;

        //fixing variables
        var whole_name = (first_name + " " + last_name).toUpperCase();
        DOB = moment(DOB).format("MM/DD/YYYY");

        //create appropriate divs and columns
        var button_key = $("<button class='patient_button'>" + whole_name + "</button>").attr("data-key", patient_Database_Key);
        var completed_button = $("<div class='col m3'>").append(button_key);
        var gender_col_m3 = $("<div class='col m3'>").text(gender);
        var DOB_col_m3 = $("<div class='col m3'>").text(DOB);
        var phone_col_m3 = $("<div class='col m3'>").text(phone);
        var div_row = $("<div class='row'>").addClass("title_underline");
        var completed_patient_div = div_row.append(completed_button).append(
                                    gender_col_m3).append(DOB_col_m3).append(
                                    phone_col_m3);

        $("#patient_list").append(completed_patient_div);

        //on button click event
        $(button_key).on("click", function(event) {
            event.preventDefault();
            var key = $(this).data("key");

            $("#all_patients").hide();
            $("#single_patient").show();

            $(".patient_back_btn").on("click", function(event){
                event.preventDefault();

                $("#first_info_row").empty();
                $("#second_info_row").empty();
                $("#third_info_row").empty();
                $("#fourth_info_row").empty();
                $("#medication_container").empty();
                $("#family_history_container").empty();
                $("#specialist_container").empty();

                $("#all_patients").show();
                $("#single_patient").hide();
            });

            inPatientDatabase.ref().child(key).once('value').then(function(){

                //vars to hold info from database child-------------------------------------------
                first_name = childSnapshot.val().first_name;
                last_name = childSnapshot.val().last_name;
                gender = childSnapshot.val().gender;
                DOB = childSnapshot.val().DOB;
                DOB = moment(DOB).format("MM/DD/YYYY");
                var age = childSnapshot.val().age;
                phone = childSnapshot.val().phone;
                var emergency_contact = childSnapshot.val().emergency_contact;
                var emergency_contact_phone = childSnapshot.val().emergency_contact_phone;
                var street = childSnapshot.val().street;
                var city = childSnapshot.val().city;
                var state = childSnapshot.val().state;
                var zip = childSnapshot.val().zip;
                var family_history = childSnapshot.val().family_history;
                var medication = childSnapshot.val().medication;
                var specialists = childSnapshot.val().specialists;
                //--------------------------------------------------------------------------------

                //vars to hold divs and info to append to page------------------------------------
                var patient_row_1 = new $("<div class='row'>");
                var first_name_div = $("<div class='col m4 div_color'>").text(first_name);
                var last_name_div = $("<div class='col m4 div_color'>").text(last_name);
                var phone_div = $("<div class='col m4 div_color'>").text(phone);
                var completed_patient_row_1 = patient_row_1.append(first_name_div).append(
                                                last_name_div).append(phone_div);

                var patient_row_2 = $("<div class='row'>");
                var DOB_div = $("<div class='col m2 offset-m3 div_color'>").text(DOB);
                var age_div = $("<div class='col m2 div_color'>").text(age);
                var gender_div = $("<div class='col m2 div_color'>").text(gender);
                var completed_patient_row_2 = patient_row_2.append(DOB_div).append(
                                                age_div).append(gender_div);

                var patient_row_3 = $("<div class='row'>");
                var street_div = $("<div class='col m3 offset-m1 div_color'>").text(street);
                var city_div = $("<div class='col m3 div_color'>").text(city);
                var state_div = $("<div class='col m2 div_color'>").text(state);
                var zip_div = $("<div class='col m2 div_color'>").text(zip);
                var completed_patient_row_3 = patient_row_3.append(street_div).append(
                                                city_div).append(state_div).append(zip_div);

                var patient_row_4 = $("<div class='row'>");
                var emergency_contact_div = $("<div class='col m4 offset-m2 div_color'>").text(emergency_contact);
                var emergency_phone_div = $("<div class='col m4 div_color'>").text(emergency_contact_phone);
                var completed_patient_row_4 = patient_row_4.append(emergency_contact_div).append(
                                                emergency_phone_div);
                //---------------------------------------------------------------------------------

                //appending the completed patient rows to html
                $("#first_info_row").append(completed_patient_row_1);
                $("#second_info_row").append(completed_patient_row_2);
                $("#third_info_row").append(completed_patient_row_3);
                $("#fourth_info_row").append(completed_patient_row_4);

                //var for medication header
                var medication_header = $("<div class='section-title'>").text("Medication(s)");

                //run loop to create buttons if medication val() is not ""
                if (medication[0] !== "") {
                    //append section title
                    $("#medication_container").append(medication_header);
                    //loop to create medication buttons
                    for (var m = 0; m < medication.length; m++) {
                        //capitalize drug name
                        var capitalized_drug = medication[m].charAt(0).toUpperCase() +
                            medication[m].slice(1);
                        //create button
                        var med_btn = $("<button class='med-btn waves-effect waves-light deep-purple darken-4'>"
                            + capitalized_drug + "</button>");
                        med_btn.attr("data-drug-name", medication[m]);
                        med_btn.attr("data-target", "drug_info_modal");

                        $("#medication_container").append(med_btn);
                    };
                };

                $(".med-btn").on("click", function(event){
                    event.preventDefault();
                    $("#drug_info_container").empty()
                    var rxcui_ID = "";
                    //var to hold drug_name from data-attr
                    var drug_name = $(this).data("drug-name");
                    //var's for modal header
                    var modal_heading = "Interactions for " + drug_name;
                    var completed_modal_header = $("<h4 id='modal_header'>").append(modal_heading);
                    $("#drug_info_container").append(completed_modal_header);

                   //vars for queryURL's
                    var rxcuiURL = "https://rxnav.nlm.nih.gov/REST/drugs.json?name=" + drug_name;

                    $.ajax({
                        url: rxcuiURL,
                        method: "GET"
                    }).done(function(response){
                        //code from API
                        rxcui_ID = response.drugGroup.conceptGroup[1].conceptProperties[0].rxcui;

                        var drugIntURL = "https://rxnav.nlm.nih.gov/REST/interaction/interaction.json?rxcui=" +
                                        rxcui_ID + "&sources=DrugBank";

                        $.ajax({
                            url: drugIntURL,
                            method: "GET"
                        }).done(function(response2){
                            var drug_name_from_database = response2.interactionTypeGroup[0].interactionType[0].minConceptItem.name;
                            drug_name_from_database = drug_name_from_database.charAt(0).toUpperCase() +
                                                        drug_name_from_database.slice(1);

                            var complete_drug_title = "Alt Name: " + drug_name_from_database;
                            var alt_name_header = $("<h5 id='alt_name_head'>").append(complete_drug_title);
                            $("#drug_info_container").append(alt_name_header);

                            var path_to_drug_pairings = response2.interactionTypeGroup[0].interactionType[0].interactionPair;

                            for (var a = 0; a < path_to_drug_pairings.length; a++) {
                                //var for pathing to info
                                var interaction_path = path_to_drug_pairings[a].interactionConcept;
                                //vars for interacting drug name and description
                                var interacting_drug = interaction_path[1].minConceptItem.name;
                                var interaction_description = path_to_drug_pairings[a].description;

                                var interacting_drug_header = "Interacting Drug: " + interacting_drug;
                                var interacting_drug_description = "Interaction: " + interaction_description;

                                var complete_interact_header = $("<h6 class='interact_head'>").append(
                                                                interacting_drug_header);
                                var complete_interact_description = $("<p class='interact_description'>").append(
                                                                interacting_drug_description);

                                $("#drug_info_container").append(complete_interact_header);
                                $("#drug_info_container").append(complete_interact_description);
                            }
                        });
                    });
                });

                //var for family history header
                var fam_hist_row = new $("<div class='row'>");
                var fam_hist_header = $("<div class='section-title'>").text("Family History");

                //run loop to add family history if family_history val() is not ""
                if (family_history[0] !== "") {
                    //append section title
                    $("#family_history_container").append(fam_hist_header);
                    //loop to create family history
                    for (var f = 0; f < family_history.length; f++) {
                        var fam_history_col = $("<div class='col m4 offset-m4 div_color'>").text(family_history[f]);
                        var completed_fam_row = fam_hist_row.append(fam_history_col);

                        $("#family_history_container").append(completed_fam_row);
                    }
                };

                //vars to hold specialists heading
                var spec_heading_div = $("<div class='row'>");
                var spec_heading_name = $("<div class='col m2 offset-m3'>").text("Specialist Name");
                var spec_heading_speciality = $("<div class='col m2'>").text("Speciality");
                var spec_heading_phone = $("<div class='col m2'>").text("Specialist Phone");
                var completed_spec_heading = spec_heading_div.append(spec_heading_name).append(
                                            spec_heading_speciality).append(spec_heading_phone);

                //var to hold all specialists created
                var all_specialists = $("<div>");
                //var for specialists header
                var spec_header = $("<div class='section-title'>").text("Specialist(s)");

                //run loop to added specialists if specialist val() is not ""
                if (specialists[0].speciality !== "") {
                    //loop to create specialist rows with info
                    for (var i = 0; i < specialists.length; i++) {
                        var div_spec_row = $("<div class='row specialist_row'>");
                        var spec_name = $("<div class='col m2 offset-m3 div_color'>").text(specialists[i].name);
                        var speciality = $("<div class='col m2 div_color'>").text(specialists[i].speciality);
                        var spec_phone = $("<div class='col m2 div_color'>").text(specialists[i].specialist_phone);
                        var completed_spec_div = div_spec_row.append(spec_name).append(
                            speciality).append(spec_phone);

                        $(all_specialists).append(completed_spec_div);

                        if (i === specialists.length-1) {
                            //appending specialist var's to appropriate div in html
                            $("#specialist_container").append(spec_header).append(
                                completed_spec_heading).append(all_specialists);
                        };
                    };
                };
            });
        });
    });
});